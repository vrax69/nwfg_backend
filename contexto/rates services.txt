bueno antes de continuar entiende que esta es la estructura general
Perfecto Brian, aqu√≠ tienes **EL RESUMEN DEFINITIVO** del *nuevo CORE de Utilities* en NWFG ‚Äî claro, estructurado, y suficientemente completo como para reabrir cualquier conversaci√≥n sin perder contexto.
Este es el **documento oficial de arquitectura**, explicado *en espa√±ol claro pero profesional*.

---

# üî• **NUEVO CORE NWFG ‚Äî MODELO DE UTILITIES (Resumen Maestro)**

*(C√≥mo funciona cada tabla, c√≥mo interact√∫an y por qu√© existen)*

---

# 1Ô∏è‚É£ **utilities** ‚Äî *LA TABLA PRINCIPAL (la entidad real de negocio)*

Esta es la tabla **padre** que representa **una utility real**, limpia, estandarizada y √∫nica.

### ‚úî Qu√© representa

Una empresa de energ√≠a en su versi√≥n estandarizada, sin importar c√≥mo venga en cada ratesheet.

### ‚úî Ejemplos reales

* AEP - Columbus Southern
* PECO
* National Grid MA
* Dominion Gas Ohio
* ConEd
* DTE

### ‚úî Qu√© NO representa

* No representa proveedores (providers)
* No representa nombres del SPL (alias)
* No representa versiones el√©ctricas/gas por separado
  ‚áí *Eso se maneja en identifiers*

### ‚úî Campos clave

| Campo           | Qu√© significa                                                           |
| --------------- | ----------------------------------------------------------------------- |
| `id`            | Identificador √∫nico                                                     |
| `standard_name` | Nombre limpio de la utility tal como debe mostrarse al usuario          |
| `state`         | Estado de operaci√≥n                                                     |
| `commodity`     | Electric / Gas / Both (solo indica si la utility opera ambos servicios) |
| `default_unit`  | Unidad principal para electricidad (si aplica)                          |
| `phone`         | Customer service                                                        |
| `website`       | Sitio de la utility                                                     |
| `logo_url`      | Logo estandarizado                                                      |

### ‚úî Por qu√© existe

Para unificar todas las utilidades dispersas en diferentes ratesheets y proveedores.

---

# 2Ô∏è‚É£ **utility_aliases** ‚Äî *LOS ALIAS DEL EXCEL, la capa de reconocimiento autom√°tico*

### ‚úî Qu√© representa

Todos los nombres posibles con los que un SPL o proveedor puede llamar una misma utility.

Ej:

Utility real = **PECO**
Aliases:

* PECO
* PECO Energy
* PECO Gas
* PECO Electric
* PECO ‚Äì Philadelphia Electric Company

### ‚úî C√≥mo funciona

Cuando importas un ratesheet:

1. El sistema extrae el nombre de utility del Excel.
2. Lo busca en `utility_aliases.alias`.
3. Si lo encuentra ‚Üí obtiene el `utility_id`.
4. Si NO lo encuentra ‚Üí el frontend activa un *stepper* para crear nuevo alias.

### ‚úî Campos clave

| Campo        | Qu√© significa                                |
| ------------ | -------------------------------------------- |
| `alias`      | El nombre EXACTO como viene en el SPL        |
| `utility_id` | A qu√© utility real pertenece                 |
| `commodity`  | Electric/Gas para ese alias espec√≠fico       |
| `unit_type`  | Unidad que aplica a ese alias (KWH/CCF/etc.) |
| `status`     | Active / Pending review                      |
| `is_global`  | Si aplica para cualquier provider            |

### ‚úî Por qu√© existe

Para que el sistema pueda entender cualquier ratesheet autom√°ticamente.

---

# 3Ô∏è‚É£ **utility_identifiers** ‚Äî *LO QUE DEBEMOS PEDIRLE AL CLIENTE SEG√öN EL SERVICIO*

### ‚úî Qu√© representa

Cada utility tiene **requisitos distintos** para identificar un cliente.

Pero, IMPORTANTE:

### üî• Cada utility puede requerir **diferentes identificadores para Electric y para Gas**.

Ejemplos reales:

| Utility          | Commodity    | Identifier                    |
| ---------------- | ------------ | ----------------------------- |
| PECO             | Electric     | Choice ID                     |
| PECO             | Gas          | Choice ID                     |
| PSEG             | Electric     | POD ID                        |
| PSEG             | Gas          | Account Number + Meter Number |
| National Grid MA | Gas          | Account + Meter               |
| ConEd            | Electric/Gas | Account Number                |

### ‚úî Qu√© contiene

| Campo               | Significado                                              |
| ------------------- | -------------------------------------------------------- |
| `utility_id`        | A qu√© utility pertenece                                  |
| `service_type`      | Electric / Gas                                           |
| `identifier_label`  | Ej. ‚ÄúChoice ID‚Äù, ‚ÄúAccount Number‚Äù, ‚ÄúPOD ID‚Äù              |
| `identifier_format` | Ej. ‚Äú10 digits‚Äù, ‚ÄúXXXXXX-XXXX‚Äù                           |
| `unit_of_measure`   | KWH / CCF / THERM / MCF ‚Üê *independiente del identifier* |
| `notes`             | Notas adicionales                                        |

### ‚úî Para qu√© existe

Para que el **frontend sepa exactamente qu√© preguntar** cuando un agente registra un cliente.

---

# 4Ô∏è‚É£ **rates** ‚Äî *Los programas de energ√≠a*

Esta tabla recibe los datos crudos ya normalizados despu√©s de importar un ratesheet.

### ‚úî Qu√© contiene

| Campo            | Significado                                            |
| ---------------- | ------------------------------------------------------ |
| `provider_id`    | El proveedor que vende el plan (Spark, CleanSky, etc.) |
| `utility_id`     | Utility real asociada                                  |
| `product_name`   | Nombre del plan                                        |
| `rate`           | Precio                                                 |
| `term`           | Meses                                                  |
| `customer_type`  | Residential / Commercial                               |
| `commodity_type` | Electric / Gas                                         |
| `unit_type`      | KWH / CCF / etc                                        |
| `raw_json`       | Datos originales del ratesheet                         |

### ‚úî Por qu√© existe

Para mantener un repositorio limpio de todos los planes ofrecidos.

---

# 5Ô∏è‚É£ **rates_view** ‚Äî *La vista final que consulta el frontend*

Esta vista combina:

* rates
* utilities
* providers
* utility_aliases (solo para referencia, no para mostrar al usuario)

### ‚úî ¬øQu√© devuelve?

Un registro por cada plan existente, con toda la metadata unificada.

| Campo         | Ejemplo  |
| ------------- | -------- |
| utility_name  | PECO     |
| state         | PA       |
| commodity     | Electric |
| unit_type     | KWH      |
| provider_name | Spark    |
| rate          | 0.1123   |
| term          | 12       |

### ‚úî Por qu√© existe

Para que el frontend no tenga que hacer JOINs complejos.

---

# üî• FLUJO COMPLETO Y DEFINITIVO

### 1. Llega un ratesheet

El sistema lee:

* SPL Utility Name
* Commodity (si existe)
* Rate
* Term
* Notes
* Etc.

### 2. Se busca el nombre del SPL en `utility_aliases`

| Caso                | Acci√≥n                                       |
| ------------------- | -------------------------------------------- |
| Alias encontrado    | Obtiene `utility_id`                         |
| Alias NO encontrado | Se activa el stepper del FE para crear alias |

### 3. Se crea un registro en **rates**

### 4. El frontend consulta:

```
SELECT * FROM rates_view WHERE utility_id = X
```

### 5. Al agente se le muestra:

* Nombre real de utility
* Todos los planes disponibles
* Identificadores requeridos seg√∫n commodity
* Unidad de medida correcta
* Tel√©fono, logo y estado

---

# üß† Concepto clave

Aunque una utility tenga BOTH,
sus **identifiers y units** se manejan por separado:

| Utility | Commodity | Unit | Identifier |
| ------- | --------- | ---- | ---------- |
| PECO    | Electric  | KWH  | Choice ID  |
| PECO    | Gas       | CCF  | Choice ID  |

Por eso `utility_identifiers` es independiente.

---

# üéØ CIERRE

El nuevo core:

* **Normaliza + unifica utilities**
* Permite importar cualquier ratesheet
* Gestiona alias autom√°ticamente
* Define qu√© datos debe pedir el agente
* Le da al front una vista simple para mostrar planes

---

Si quieres, ahora puedo generar:

### ‚úî CRUD completo (insert massive)

### ‚úî queries de ejemplo

### ‚úî diagramas del modelo

### ‚úî explicaci√≥n para desarrolladores

### ‚úî explicaci√≥n para tu profesor / empresa

Dime qu√© quieres.

Schema: Nwfg_master
Table: rates
Columns:
id bigint AI PK 
provider_id int 
utility_id bigint 
product_name varchar(255) 
program_code varchar(100) 
rate decimal(9,6) 
msf decimal(9,6) 
etf varchar(50) 
term int 
customer_type enum('Residential','Commercial','Industrial') 
commodity_type enum('Electric','Gas') 
unit_type enum('KWH','THERM','CCF','MCF') 
ptc decimal(9,6) 
savings decimal(9,6) 
special_offers text 
notes text 
raw_json json 
import_batch_id varchar(100) 
validation_status enum('Pending','Validated','Rejected','In Review') 
created_at timestamp 
updated_at timestamp
Table: script_assignments
Columns:
assignment_id bigint AI PK 
script_id bigint 
user_id bigint 
role enum('reader','editor','reviewer')
Table: script_sections
Columns:
section_id bigint AI PK 
script_id bigint 
section_order int 
section_name varchar(255) 
section_text longtext 
conditions json
Table: scripts
Columns:
script_id bigint AI PK 
provider_id int 
language enum('EN','ES') 
channel enum('Inbound','Outbound','TPV','QA') 
script_title varchar(255) 
version varchar(50) 
created_at timestamp 
updated_at timestamp
Table: utilities
Columns:
id bigint AI PK 
standard_name varchar(255) 
state varchar(10) 
commodity enum('Gas','Electric','Both') 
default_unit enum('KWH','THERM','CCF','MCF') 
phone varchar(50) 
website varchar(300) 
logo_url varchar(300) 
active tinyint 
created_at timestamp 
updated_at timestamp
Table: utility_aliases
Columns:
id bigint AI PK 
alias varchar(255) 
utility_id bigint 
status enum('Active','Inactive') 
notes text 
created_at timestamp
Table: utility_identifiers
Columns:
id bigint AI PK 
utility_id bigint 
service_type enum('Electric','Gas') 
identifier_label varchar(255) 
identifier_format varchar(500) 
unit_of_measure enum('KWH','THERM','CCF','MCF') 
notes text 
created_at timestamp

no olvides que todos los env van en la raiz
C:\Users\bllanes\Documents\nwfg_docker\env


-------------
üî• PLAN MAESTRO DE CONSTRUCCI√ìN ‚Äî RATES SERVICE (Fase por Fase)

Este ser√° nuestro roadmap oficial, ordenado, sin saltos, igual al users-service, listo para pasar a producci√≥n con Docker y Ubuntu.

Lo haremos por capas, asegurando que cada una funcione antes de avanzar.

‚úÖ FASE 1 ‚Äî Configuraci√≥n base del microservicio
Objetivo:

Que el servicio corra vac√≠o, responda /health, y tenga conexi√≥n a ambas BD.

Archivos a crear/llenar:

package.json

.dockerignore

app.js

server.js

src/config/db.js

src/routes/health.routes.js

src/controllers/health.controller.js

Resultado:

npm start o docker compose up ‚Üí servicio arrancado en localhost:4003/health.

üëâ Esta fase la hacemos inmediatamente.

‚úÖ FASE 2 ‚Äî M√≥dulo UTILITIES (base del core)

Antes de rates, necesitamos utilities funcional.

Endpoints:
GET

/utilities

/utilities/:id

POST

/utilities (crear utility est√°ndar)

/utilities/:id/identifiers

/utilities/:id/aliases

Archivos a llenar:

src/controllers/utilities.controller.js

src/models/utilities.model.js

src/routes/utilities.routes.js

src/validators/utility.validator.js (opcional m√°s adelante)

db.js (funci√≥n dedicada para queries)

Resultado:

Frontend podr√°:

Mostrar todas las utilities

Mostrar utility + identifiers + aliases

Crear nuevas utilities

‚úÖ FASE 3 ‚Äî Aliases: Resolver, Crear y Normalizar

El sistema depende de resolver alias cuando llega un Excel.

Endpoints:

GET

/aliases

/aliases/resolve?alias=texto

/aliases/utility/:utility_id

POST

/aliases (crear alias nuevo)

Archivos:

alias.model.js

aliasResolver.js (cerebro del reconocimiento)

aliases.controller.js

aliases.routes.js

Resultado:

Resolver nombres del SPL autom√°ticamente

Crear alias desde interfaz del admin

‚úÖ FASE 4 ‚Äî Identifiers (qu√© pedir al cliente)

Endpoints:

GET

/identifiers?utility_id=X

/identifiers/:id

POST

/identifiers

PUT

/identifiers/:id

Archivos:

identifiers.model.js

identifiers.controller.js

identifiers.routes.js

Resultado:

Saber qu√© identificadores pedir seg√∫n utility y commodity.

üî• FASE 5 ‚Äî RATES (n√∫cleo del microservicio)

Este es el m√≥dulo m√°s importante.

Endpoints:

GET

/rates

/rates/:id

POST

/rates/bulk ‚Üê Importaci√≥n masiva desde Excel normalizado

PATCH

/rates/:id/status

POST

/rates/batch/:id/reject

Archivos:

rates.model.js

rates.controller.js

rates.routes.js

rate.validator.js

Resultado:

Rates importados correctamente

Validaci√≥n, rechazo, edici√≥n de status

Integraci√≥n con importer (Kafka opcional)

üî• FASE 6 ‚Äî Integraci√≥n con Providers (user_data_tpv_staging)

Aqu√≠ conectamos el rates-service al esquema del user-service:

Tablas que usaremos:

proveedores ‚Üí listar providers en el front

(si hace falta) user_provider_account ‚Üí permisos por proveedor

Endpoints nuevos:

/providers

/providers/:id

Archivos:

providers.model.js

providers.controller.js

providers.routes.js

Resultado:

El servicio sabr√° qu√© providers existen

Rates podr√°n asignarse correctamente al provider_id

üî• FASE 7 ‚Äî Normalizadores y l√≥gica avanzada del sistema

Archivos en /utils:

rateNormalizer.js ‚Üí convierte los datos del Excel a JSON listo para bulk

aliasResolver.js ‚Üí matching fuzzy entre nombres

commodityResolver.js ‚Üí determine Electric / Gas / Both

logger.js ‚Üí logs estandarizados

üî• FASE 8 ‚Äî Seguridad y Middleware

Cargar JWT igual que en user-service

auth.middleware.js

Roles (Admin, QA, Agent)

Permisos:

Admin ‚Üí CRUD total

QA ‚Üí revisar rates, cambiar status

Agente ‚Üí solo consultar rates/utilities

üî• FASE 9 ‚Äî DOCKER + DEPLOY

Archivos:

Dockerfile

Node 20 alpine

Copiar app

Exponer puerto

CMD correcto

docker-compose.yml

Variables del env

Conexiones DB

.env

Debe ir en:

C:\Users\bllanes\Documents\nwfg_docker\env\rates.env


Variables ejemplo:

PORT=4003
MASTER_DB_HOST=host.docker.internal
MASTER_DB_USER=root
MASTER_DB_PASSWORD=1234
USER_DB_HOST=host.docker.internal
USER_DB_USER=root
USER_DB_PASSWORD=1234
JWT_SECRET=mysecret

üî• FASE 10 ‚Äî Pasar a Producci√≥n (Ubuntu Server)

Pasos:

git pull o subir carpeta

docker build -t rates-service .

docker compose up -d

Nginx reverse proxy

Hacerlo accesible v√≠a:

https://api.nwfg.com/rates

Perfecto. Te dejo LA LISTA CONSOLIDADA Y SEPARADA POR SPL / PROVIDER de TODOS los headers que existen en los ratesheets que mencionaste, sin inventar nada y respetando que Elektra Spark ‚â† Spark Energy ‚â† Spark (SPE).

Esto es lo que vamos a cubrir con rateNormalizer + raw_json.

üìÑ HEADERS POR RATESHEET / PROVIDER
üîπ 1. CleanSky / CS / CSE / Clean Sky Energy

Headers reales:

State
Utility
Product Name
Program Code
CleanSky's Rate
MSF
Term
ETF
Notes

üîπ 2. Eco Plus / Eco Energy

‚ö†Ô∏è Antes NO hab√≠a ratesheet, ahora S√ç (actualizado hoy)

Headers nuevos:

Utility
Commodity
Marketer/Vendor
Rate Class Code
Rate Class Description
Comments
Service Fee
Rate
Adder
Status
Account Type
sRateClass2Code
iRateClass2Term
sRateClass3Code
iRateClass3Term

üîπ 3. Elektra Spark (SPL independiente)

üëâ No compartas headers con Spark Energy

Headers conocidos / m√≠nimos:

Utility
Commodity
Rate
Term
MSF
ETF
Product Name
Program Code
Notes


(Muchos valores vienen fijos / manuales)

üîπ 4. Spark Energy (SPE)

Headers completos:

ProductID
CompanyDBAName
Market
Full Utility Name
ProductName
Commodity
UtilityState
UnitOfMeasure
ProductType
Rate
PTC
Savings?
MSF
EarlyTerminationFee
Term
CustomerTypes
RenewablePercentage
SpecialOffers

üîπ 5. Indra Energy

Tabla semi-manual / portal

Headers identificados:

Utility
Portal URL
Rate
Status
Provider Code
Program Code
Created At


(Muchos campos vienen vac√≠os o fijos)

üîπ 6. NextVolt

Headers (formato est√°ndar simple):

State
Utility
Commodity
Product Name
Rate
Term
MSF
ETF
Customer Type
Notes

üîπ 7. NGE ‚Äì National Gas & Electric

Headers oficiales:

Program Code
Market
Utility
Customer Type
Commodity
Plan Type
Term
Promo Code
Rate ($)
Monthly Service Fee ($)
Cancellation Fee ($)
Notes

üîπ 8. Polaris

Headers conocidos:

Utility
Commodity
Rate
Term
MSF
ETF
Rate Duration
Product Name
Program Code

üîπ 9. Rushmore

Headers:

Utility
Commodity
Rate
Term
MSF
ETF
Customer Type
Status
Notes


(Ejemplo que mostraste es manual)

üîπ 10. WGL

Headers completos:

Commodity
Brand Name
Utility Provider
Abbreviation
Customer Type
Program Name
Program Code
Rate ($)
Unit
ETF ($)
MSF ($)
Term (Months)
Zipcodes
Promo
CSO%
Wind%
Rate Type

üß† HEADERS TRANSVERSALES (APARECEN EN VARIOS)

Estos aparecen con nombres distintos pero mismo significado:

Concepto	Variantes
Utility	Utility / Full Utility Name / Utility Provider
Rate	Rate / CleanSky's Rate / Rate ($)
Term	Term / Term (Months)
MSF	MSF / Monthly Service Fee ($) / Service Fee
ETF	ETF / EarlyTerminationFee / Cancellation Fee
Commodity	Commodity
Product	Product Name / Program Name
Program Code	Program Code / ProductID
Notes	Notes / Comments
üéØ CONCLUSI√ìN CLAVE (IMPORTANTE)

NO vamos a crear columnas nuevas

NO todos los headers mapean

TODO lo no mapeado va a raw_json

rates cubre el 90%

raw_json cubre el 100%

Este listado es la base exacta para construir:

rateNormalizer.js

Validaciones por provider

Bulk insert limpio



