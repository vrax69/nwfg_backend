Para entender c칩mo funciona el flujo exactamente, vamos a mapear el contenido real del script de **CleanSky Energy**  hacia tu nueva base de datos modular.

La clave es que el backend ya no entrega un solo "bloque" de texto, sino una **colecci칩n de fragmentos** que el frontend ensambla en el "Teleprompter" bas치ndose en el plan que el agente seleccion칩 en la `agent_rates_view`.

---

### 1. Desglose del Script en la Base de Datos (`script_sections`)

As칤 es como se ver칤an los registros en tu tabla para el script de CleanSky:

| section_order | section_name | target_state | target_commodity | section_text (Contenido din치mico) |
| --- | --- | --- | --- | --- |
| **10** | Intro | `NULL` | `NULL` | "Gracias por llamar a CTS, mi nombre es **{{agent_name}}**. Esta llamada est치 siendo grabada..." 

 |
| **20** | Promo Gift Card | **'PA','MA','OH'** | `NULL` | "[S칍LO PARA PA, MA Y OH] Adem치s, podr칤a recibir hasta $100 en tarjetas regalo..." 

 |
| **30** | Pitch Electric | `NULL` | **'Electric'** | "El plan **{{product_name}}** ofrece una tarifa fija de **{{rate}}** por **{{unit_type}}**..." 

 |
| **40** | Pitch Gas | `NULL` | **'NaturalGas'** | "Su nueva tarifa fija de gas natural ser치 el plan **{{product_name}}** con una tarifa de **{{rate}}**..." 

 |
| **50** | Verification MI | **'MI'** | `NULL` | "Para Michigan: Una vez finalicemos esta inscripci칩n, recibir치s un correo de TPV360..." 

 |

---

### 2. El Flujo de Ejecuci칩n (Paso a Paso)

Imagina que el agente est치 en el Dashboard y selecciona un plan de CleanSky para un cliente en **Michigan** que quiere **Electricidad**.

#### Paso A: Selecci칩n en Frontend

El agente hace clic en un plan de la tabla `agent_rates_view`. El frontend obtiene los par치metros:

* `provider_id`: 1 (CleanSky)
* `state`: 'MI'
* `commodity_type`: 'Electric'

#### Paso B: Query al Backend (scripts-service)

El servicio de scripts ejecuta una consulta que filtra las secciones que "califican" para ese contexto espec칤fico:

```sql
SELECT section_text FROM script_sections 
WHERE script_id = (SELECT script_id FROM scripts WHERE provider_id = 1 AND is_active = 1)
AND (target_state = 'MI' OR target_state IS NULL)
AND (target_commodity = 'Electric' OR target_commodity IS NULL)
ORDER BY section_order ASC;

```

#### Paso C: Inyecci칩n de Variables (El Teleprompter)

El backend (o el frontend) toma el texto y reemplaza los `{{placeholders}}` con los datos reales del plan seleccionado:

* `{{agent_name}}`  "Brian"
* `{{product_name}}`  "Eco Rewards 12"
* `{{rate}}`  "0.125"

---

### 3. Visualizaci칩n en el Frontend (`/home/scripts`)

En el editor que viste en la captura de pantalla, el flujo para el QA ser칤a:

1. 
**Sidebar**: Selecciona "CleanSky Energy".


2. 
**Lista de Bloques**: Aparecen tarjetas numeradas (Intro, Promo, Pitch, etc.).


3. 
**Configuraci칩n de Bloque**: El QA hace clic en el bloque "Gift Card" y en el panel derecho marca: *"Mostrar solo si Estado IN (PA, MA, OH)"*.


4. 
**Editor de Texto**: El QA escribe el guion legal y usa un bot칩n de "Insertar Variable" para colocar `{{rate}}` justo donde CleanSky exige que se mencione el precio.



### 游눠 Por qu칠 esto es "Pro"

Si ma침ana CleanSky decide que en **Ohio** ya no dan tarjetas de regalo, el QA entra al editor, busca ese bloque espec칤fico y cambia el filtro de `target_state` quitando 'OH'. **No hay que tocar el c칩digo**, el cambio es instant치neo para todos los agentes.

**쯊e gustar칤a que dise침emos ahora el `Type Definition` de GraphQL para este objeto `ScriptSection`, incluyendo estos campos de `target_state` y `target_commodity`?** Con eso, el backend ya sabr칤a qu칠 datos enviar.